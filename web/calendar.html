<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Admin Calendar</title>

        <!-- head -->
        <!-- demo stylesheet -->
        <link type="text/css" rel="stylesheet" href="latest/helpers/demo.css?v=2018.2.232" />    
        <link type="text/css" rel="stylesheet" href="latest/helpers/media/layout.css?v=2018.2.232" />    
        <link type="text/css" rel="stylesheet" href="latest/helpers/media/elements.css?v=2018.2.232" />   

        <!-- helper libraries -->
        <script src="latest/helpers/jquery-1.9.1.min.js" type="text/javascript"></script>

        <!-- daypilot libraries -->
        <script src="latest/js/daypilot-calendar.src.js" type="text/javascript"></script>
        <script src="latest/js/daypilot-common.src.js" type="text/javascript"></script>
        <!-- daypilot themes -->
        <link type="text/css" rel="stylesheet" href="latest/themes/month_white.css?v=2018.2.232" />
        <link type="text/css" rel="stylesheet" href="latest/themes/month_green.css?v=2018.2.232" />    
        <link type="text/css" rel="stylesheet" href="latest/themes/month_transparent.css?v=2018.2.232" />    

        <link type="text/css" rel="stylesheet" href="latest/themes/calendar_transparent.css?v=2018.2.232" />    
        <link type="text/css" rel="stylesheet" href="latest/themes/calendar_white.css?v=2018.2.232" />    
        <link type="text/css" rel="stylesheet" href="latest/themes/calendar_green.css?v=2018.2.232" />    

        <link type="text/css" rel="stylesheet" href="latest/themes/navigator_green.css?v=2018.2.232" />    
        <link type="text/css" rel="stylesheet" href="latest/themes/navigator_white.css?v=2018.2.232" />    

        <!-- /head -->

        <link rel="stylesheet" href="JMobile/css/themes/default/jquery.mobile-1.4.5.min.css">
        <link rel="stylesheet" href="JMobile/_assets/css/jqm-demos.css">
        <link rel="shortcut icon" href="JMobile/favicon.ico">
        <script src="JMobile/js/jquery.js"></script>
        <script src="JMobile/_assets/js/index.js"></script>
        <script src="JMobile/js/jquery.mobile-1.4.5.min.js"></script>
        <link href="media/mydesign.css" rel="stylesheet" type="text/css"/>
        <script src="js/jquery.validate.min.js" type="text/javascript"></script>
        <script src="js/additional-methods.js" type="text/javascript"></script>
        <script src="Gritter/js/jquery.gritter.min.js" type="text/javascript"></script>
        <script src="js/webStorage.js" type="text/javascript"></script>
        <script src="js/service/SchedulerService.js" type="text/javascript"></script>

        <script src="js/service/engine.js" type="text/javascript"></script>

        <script src="js/service/util.js" type="text/javascript"></script>
    </head>

    <body>

        <!-- Start of second page: #two -->
        <div data-role="page" id="two" data-theme="a">

            <!--            <div data-theme="b" data-role="header">
                            <h4>Channeling System</h4>
                        </div> /header -->

            <div role="main" class="ui-content">
<!--                <fieldset id="date_mode" data-role="controlgroup" data-type="horizontal" data-mini="true">
                    <legend></legend>
                    <input type="radio" name="radio-choice-a" id="mode-choice-f" value="Week" checked="checked">
                    <label for="mode-choice-f">Week View</label>
                    <input type="radio" name="radio-choice-a" id="mode-choice-g" value="Custom">
                    <label for="mode-choice-g">Available</label>
                </fieldset>-->

                <h4 style='text-align: center;margin-top: 0px;margin-bottom: 0px;' id='sum-text'></h4>
                <input type="hidden" name="loc_menu"/>
                <div class="ui-field-contain">

                    <label for="fcr-menu">Beautician:</label>

                    <select name="select-native-2" id="fcr-menu" data-mini="true"></select>
                </div>
                <div style="text-align:right" id="date_range" data-role="controlgroup" data-type="horizontal" data-mini="tprevrue" >
                    <legend></legend>
                    <a id="prev" data-ajax="false"  onclick="history.back();" hidden>Previous</a>

                    <a id="next" data-ajax="false" href="#" hidden>Next</a>
                </div>


                <div id="dp"></div>
                <label id="error-text" class=""></div>
<!--            <form action="step3.html" data-ajax="false" id="form1">
                <p style="text-align: right">
                    <a class="ui-input-btn" href="index.html" data-ajax="false" data-role="button" data-inline="true" >BACK</a>

                    <input id="nxt_btn" type="button" data-ajax="false" data-role="button" data-inline="true" data-theme="b" value="NEXT"/>

                </p>
            </form>-->


        </div><!-- /content -->


        <script src="js/custom.js" type="text/javascript"></script>
        <script>

                        $(document).ready(function () {

                            var fcls = [];
                            var replyFac = function (data)
                            {
                                if (data != null && typeof data == 'object') {
                                    //console.log(data);
                                    $.each(data, function (i, v) {
                                        fcls.push({name: v.name, id: v.id});
                                    })
                                    LoadDropDown(fcls, "#fcr-menu", false);

                                    var url_string = window.location.href;
                                    var url = new URL(url_string);
                                    var fr = url.searchParams.get("fr");
                                    if (fr === null || fr === "") {
                                        $('#fcr-menu').val(fcls[0].id);
                                        fr = fcls[0].id;
                                    } else {
                                        $('#fcr-menu').val(fr);
                                    }
                                    function findSelFcr(fcrEle) {
                                        return fcrEle.id == fr;
                                    }
                                    var Sfcr = fcls.find(findSelFcr);
                                    setFacrDetails(Sfcr);
                                    //alert(Sfcr)

                                    $('#fcr-menu').selectmenu('refresh');



                                    var c = url.searchParams.get("d");
                                    if (c === null || c === '') {
                                        c = formatDate(new Date());
                                    }
                                    //alert(fr);
                                    SchedulerService.getAllSsns(formatDate(new Date()), c, 1, fr, replySSNList);

                                } else
                                    dwr.util.setValue('d12', dwr.util.toDescriptiveString(data, 1));
                            }
                            $('#fcr-menu').change(function () {
                                var valu = $(this).val();
                                var url_string = window.location.href;
                                var url = new URL(url_string);
                                url.searchParams.delete("fr");
                                url.searchParams.append("fr", valu);
                                window.location.href = url;
                            })
                            SchedulerService.getAllFacilitators(replyFac)


//                            var sumtxt = [];
//                            var srchObj = getSrchItems();
//
//                            if (srchObj.loc !== '') {
//                                sumtxt.push(srchObj.loc);
//                            }
//                            if (srchObj.spc !== '') {
//                                sumtxt.push(srchObj.spc);
//                            }
//                            if (srchObj.fcy !== '') {
//                                sumtxt.push(srchObj.fcy);
//                            }
//
//                            $('#sum-text').text(sumtxt.join(', '));

                            var viewCount = 5;
                            var dp = new DayPilot.Calendar("dp");
                            var allSsns = [];
                            var allSsnsIndex = 0;
                            dp.viewTypeCustomDateArray = []; // day/week/custom
                            dp.businessBeginsHour = 24;
                            dp.businessEndsHour = 0;

                            // functions of prev/ next button
                            function RefreshTheCalendar() {
                                var url_string = window.location.href;

                                var url = new URL(url_string);
                                var c1 = url.searchParams.get("d");
                                if (!(c1 === "" || c1 === null)) {
                                    $('#prev').show();
                                }
                                var purl = new URL(url_string);

                                if (allSsns.length === 0) {
                                    dp.viewTypeCustomDateArray = [];
                                } else if (allSsns.length < viewCount) {
                                    dp.viewTypeCustomDateArray = allSsns.splice(0, allSsns.length);

                                    SchedulerService.getApmtList(dp.viewTypeCustomDateArray[0], dp.viewTypeCustomDateArray[dp.viewTypeCustomDateArray.length - 1], 1, $('#fcr-menu').val(), replyApmtList);
                                } else {
                                    if (allSsns.length > viewCount)
                                        $('#next').show();
                                    var nurl = new URL(url_string);
                                    var c = nurl.searchParams.get("d");
                                    if (c === "" || c === null) {
                                        nurl.searchParams.append("d", allSsns[viewCount - 1]);
                                    } else {
                                        nurl.searchParams.delete("d");
                                        nurl.searchParams.append("d", allSsns[viewCount - 1]);
                                    }

                                    $('#next').attr('href', nurl);
                                    dp.viewTypeCustomDateArray = allSsns.splice(0, viewCount);
                                    SchedulerService.getApmtList(dp.viewTypeCustomDateArray[0], dp.viewTypeCustomDateArray[viewCount - 1], 1, $('#fcr-menu').val(), replyApmtList);

                                }

                            }

                            var replyApmtList = function (data) {

                                if (data != null && typeof data == 'object') {
                                    console.log(data);
                                    $.each(data, function (i, v) {

                                        if (v.stts === -1) {
                                            var e = new DayPilot.Event({
                                                start: new DayPilot.Date(formatDate(v.ssn.dat) + "T" + formatTime(v.start)),
                                                end: new DayPilot.Date(formatDate(v.ssn.dat) + "T" + formatTime(v.end)),
                                                id: v.ref,
                                                text: v.appointer.name + "&nbsp;" + v.appointer.phone + "<br>" + formatDate(v.ssn.dat) + " (" + formatAMPM(v.start) + "-" + formatAMPM(v.end) + ")",
                                                cssClass: 'booked',
                                                resizeDisabled: true,
                                                //   moveDisabled: true,
                                                //   deleteDisabled: true,
                                                //   clickDisabled: true,
                                                barHidden: true,
                                                fontColor: "black",
                                                backColor: "#FFE599",
                                                borderColor: "#F1C232",
                                            });
                                            dp.events.add(e);
                                        } else {
                                            var e = new DayPilot.Event({
                                                start: new DayPilot.Date(formatDate(v.ssn.dat) + "T" + formatTime(v.start)),
                                                end: new DayPilot.Date(formatDate(v.ssn.dat) + "T" + formatTime(v.end)),
                                                id: v.ref,
                                                text: v.appointer.name + "&nbsp;" + v.appointer.phone + "<br>" + formatDate(v.ssn.dat) + " (" + formatAMPM(v.start) + "-" + formatAMPM(v.end) + ")",
                                                cssClass: 'booked',

                                                borderColor: "#CC0000",
                                                resizeDisabled: true,
                                                // moveDisabled: true,
                                                // deleteDisabled: true,
                                                // clickDisabled: true,
                                                barHidden: true,
                                                fontColor: "#fff",
                                                backColor: "#E06666"
                                            });
                                            dp.events.add(e);
                                        }

                                    });
                                } else
                                    dwr.util.setValue('d12', dwr.util.toDescriptiveString(data, 1));
                            }
                            // calendar js
                            var replySSNList = function (data)
                            {
                                if (data != null && typeof data == 'object') {
                                    //console.log(data);
                                    $.each(data, function (i, v) {
                                        //dp.viewTypeCustomDateArray.push(formatDate(v.dat));
                                        allSsns.push(formatDate(v.dat));
                                        //alert(v.start.getHours())
                                        if (i < viewCount) {
                                            if (dp.businessBeginsHour > v.start.getHours()) {
                                                dp.businessBeginsHour = v.start.getHours();
                                            }
                                            if (dp.businessEndsHour < v.end.getHours()) {
                                                dp.businessEndsHour = v.end.getHours();
                                            }
                                        }

                                    });

                                    RefreshTheCalendar();
                                    if (data.length > 0) {
                                        dpinit();

                                    } else {
                                        alert('No appointments details found')
                                    }

                                    $.each(data, function (i, v) {


                                        if (dp.businessBeginsHour < v.start.getHours()) {
                                            var e = new DayPilot.Event({
                                                start: new DayPilot.Date(formatDate(v.dat) + "T" + (dp.businessBeginsHour >= 10 ? dp.businessBeginsHour : "0" + dp.businessBeginsHour) + ":00:00"),
                                                end: new DayPilot.Date(formatDate(v.dat) + "T" + (v.start.getHours() >= 10 ? v.start.getHours() : "0" + v.start.getHours()) + ":00:00"),
                                                id: DayPilot.guid(),
                                                text: "Not available slots",
                                                cssClass: 'booked',
                                                resizeDisabled: true,
                                                moveDisabled: true,
                                                deleteDisabled: true,
                                                clickDisabled: true,
                                                barHidden: true

                                            });
                                            dp.events.add(e);
                                        }
                                        if (dp.businessEndsHour > v.end.getHours()) {
                                            var e = new DayPilot.Event({
                                                start: new DayPilot.Date(formatDate(v.dat) + "T" + (v.end.getHours() >= 10 ? v.end.getHours() : "0" + v.end.getHours()) + ":00:00"),
                                                end: new DayPilot.Date(formatDate(v.dat) + "T" + (dp.businessEndsHour >= 10 ? dp.businessEndsHour : "0" + dp.businessEndsHour) + ":00:00"),
                                                id: DayPilot.guid(),
                                                text: "Not available slots",
                                                cssClass: 'booked',
                                                resizeDisabled: true,
                                                moveDisabled: true,
                                                deleteDisabled: true,
                                                clickDisabled: true,
                                                barHidden: true

                                            });
                                            dp.events.add(e);
                                        }
                                    });


                                } else
                                    dwr.util.setValue('d12', dwr.util.toDescriptiveString(data, 1));
                            }


                            var mySelEvents = [];
                            function dpinit() {
                                selectedSlotCount = 0;

                                // view
                                dp.startDate = new Date()//"2019-03-01";  // or just dp.startDate = "2013-03-25";
                                dp.viewType = "Custom"; // day/week/custom
                                //        var nextAppointmentDays = ['2018-12-27', '2018-12-30', '2019-01-02'];
                                //        var prevAppointmentDays = ['2018-12-01', '2018-12-02', '2019-12-05'];
                                dp.initScrollPos = 0; // fixing auto scroll
                                dp.durationBarVisible = true;
                                //dp.eventDeleteHandling = 'Update';
                                dp.slotDurationInMin = 30;
                                dp.cellHeight = 35;
                                dp.heightSpec = 'BusinessHoursNoScroll';
                                dp.headerCellType = 'MiniuteWise';
                                //dp.businessBeginsHour = 8;
                                //dp.businessEndsHour = 17;
                                //dp.rtl = true;
                                //dp.locale = "ar-ae";
                                var maxSlotSelection = 1;


                                var getSelectedSlotsCount = function getSelectedSlotsCount(start, end) {

                                    return ((new Date(end) - new Date(start)) / (1000 * 60)) / dp.slotDurationInMin;

                                }

                                var checkMaxSlotsCountExceed = function checkMaxSlotsCountExceed(start, end) {
                                    var crntSelCount = getSelectedSlotsCount(start, end);
                                    if (selectedSlotCount + crntSelCount > maxSlotSelection) {
                                        return true;
                                    } else {
                                        selectedSlotCount += crntSelCount;
                                        return false;
                                    }
                                }
                                // event creating
                                //dp.timeRangeSelectedHandling = 'JavaScript';
                                dp.onTimeRangeSelected = function (args) {
                                    //var name = prompt("New event name:", "Event");
                                    //if (!name)
                                    //   return;
                                    if (checkMaxSlotsCountExceed(args.start, args.end)) {
                                        $('#error-text').addClass('error').text('Maximum selected slot count exceeded');
                                        setTimeout(function () {
                                            $('#error-text').removeClass('error').text('');
                                        }, 3000);


                                        dp.clearSelection();
                                        return;
                                    }

                                    var name = args.start.toString("hh:mm tt") + '-' + args.end.toString("hh:mm tt");

                                    var e = new DayPilot.Event({
                                        start: args.start,
                                        end: args.end,
                                        id: DayPilot.guid(),
                                        text: name,
                                        backColor: "#9FC5E8",
                                        borderColor: "#3D85C6",

                                        resizeDisabled: true,
                                        //  moveDisabled: true,
                                        "tags": {
                                            "type": "new"

                                        }
                                    });

                                    dp.events.add(e);

                                    dp.clearSelection();
                                };

                                dp.onEventResized = function (args) {
                                    //alert(args.newStart)
                                    console.log(args)
                                    if (checkMaxSlotsCountExceed(args.newStart, args.newEnd)) {
                                        $('#error-text').addClass('error').text('Maximum selected slot count exceeded');
                                        setTimeout(function () {
                                            $('#error-text').removeClass('error').text('');
                                        }, 3000);


                                        dp.clearSelection();
                                        return;
                                    }
                                    if (IsMyevent(args)) {

                                    }
                                    var e = ref;
                                    e.start(args.newStart);
                                    e.end(args.newEnd);
                                    dp.events.update(e);
                                    dp.clearSelection();
                                }
                                
                                var replyCancelSsn = function (data){}
                                

                                dp.onEventDeleted = function (args) {
                                    if(confirm("Are you sure you want to cancel the Booking?")){
                                        //console.log(ref);
                                        SchedulerService.cancelSsn(args.e.id(), replyCancelSsn );
                                        dp.events.remove(args.e);
                                        selectedSlotCount -= getSelectedSlotsCount(args.e.start(), args.e.end());
                                    }
                                    
                                }

                                dp.onEventClick = function (args) {
                                    // alert("clicked: " + args.e.id());
                                };

                                // is events already selected get it from session
                                // updateSelEvents();
                                function updateSelEvents() {
                                    var events = getSelEvents();

                                    $.each(events, function (i, ele) {
                                        checkMaxSlotsCountExceed(ele.start, ele.end);
                                        dp.events.add(new DayPilot.Event({
                                            start: new DayPilot.Date(ele.start),
                                            end: new DayPilot.Date(ele.end),
                                            backColor: "#9FC5E8",
                                            borderColor: "#3D85C6",
                                            id: ele.id,
                                            resizeDisabled: true,
                                            //                                       moveDisabled: true,
                                            text: ele.text,
                                            "tags": ele.tags
                                        }));
                                    })
                                }

                                //
                                dp.events.list = [];
                                dp.onBeforeEventRender = function (args) {
                                    if (args.data.tags && args.data.tags.type === "important") {
                                        args.data.html = "<b>Already Booked</b><br>" + args.data.text;
                                        args.data.fontColor = "#fff";
                                        args.data.backColor = "#E06666";
                                    }
                                };

                                dp.init();

                                // updated selected events
                                updateSelEvents();

                                $('#nxt_btn').click(function (e) {
                                    $('#error-text').removeClass('error').text("");

                                    if (selectedSlotCount < 1) {
                                        e.preventDefault();
                                        $('#error-text').addClass('error').text("Please select a slot to continue");
                                    } else {

                                        for (var i = 0; i < dp.events.list.length; i++) {
                                            if (dp.events.list[i].tags !== undefined && dp.events.list[i].tags.type === "new") {
                                                mySelEvents.push(dp.events.list[i]);
                                            }
                                        }
                                        // save the events on session
                                        setEvents(mySelEvents);


                                        $('#form1').submit();
                                    }

                                });

                            }


                            //    var e = new DayPilot.Event({
                            //        start: new DayPilot.Date("2018-12-26T12:00:00"),
                            //        end: new DayPilot.Date("2018-12-26T14:00:00").addHours(3),
                            //        id: DayPilot.guid(),
                            //        text: "Special event",
                            //        cssClass: 'booked',
                            //        resizeDisabled: true,
                            //        moveDisabled: true,
                            //        deleteDisabled: true,
                            //        clickDisabled: true,
                            //        barHidden: true
                            //
                            //    });
                            //    dp.events.add(e);

                            $('input[name="radio-choice-a"]').change(function () {
                                var val = $(this).val();

                                dp.viewType = val;
                                dp.update();


                            });


                            Date.prototype.addDays = function (days) {
                                var date = new Date(this.valueOf());
                                date.setDate(date.getDate() + days);
                                return date;
                            }

                            //    $('#next').click(function () {
                            //        if (dp.viewType === "Week") {
                            //            dp.startDate = dp.startDate.addDays(+7);
                            //            dp.update();
                            //        } else {
                            //            prevAppointmentDays = dp.viewTypeCustomDateArray;
                            //            dp.viewTypeCustomDateArray = nextAppointmentDays;
                            //            nextAppointmentDays = GenerateRandomArray('next');
                            //            dp.update();
                            //        }
                            //    });
                            //    $('#prev').click(function () {
                            //        if (dp.viewType === "Week") {
                            //            dp.startDate = dp.startDate.addDays(-7);
                            //            dp.update();
                            //        } else {
                            //            nextAppointmentDays = dp.viewTypeCustomDateArray;
                            //            dp.viewTypeCustomDateArray = prevAppointmentDays;
                            //            prevAppointmentDays = GenerateRandomArray('prev');
                            //            dp.update();
                            //        }
                            //    });






                            function formatTime(tTime) {
                                var d = new Date(tTime),
                                        hours = '' + (d.getHours()),
                                        mins = '' + d.getMinutes(),
                                        seconts = '' + d.getSeconds();
                                if (hours.length < 2)
                                    hours = '0' + hours;
                                if (mins.length < 2)
                                    mins = '0' + mins;
                                if (seconts.length < 2)
                                    seconts = '0' + seconts;
                                return [hours, mins, seconts].join('-');
                            }


                            function formatDate(date) {
                                var d = new Date(date),
                                        month = '' + (d.getMonth() + 1),
                                        day = '' + d.getDate(),
                                        year = d.getFullYear();

                                if (month.length < 2)
                                    month = '0' + month;
                                if (day.length < 2)
                                    day = '0' + day;

                                return [year, month, day].join('/');
                            }

                            function formatAMPM(date) {
                                var hours = date.getHours();
                                var minutes = date.getMinutes();
                                var ampm = hours >= 12 ? 'pm' : 'am';
                                hours = hours % 12;
                                hours = hours ? hours : 12; // the hour '0' should be '12'
                                minutes = minutes < 10 ? '0' + minutes : minutes;
                                var strTime = hours + ':' + minutes + ' ' + ampm;
                                return strTime;
                            }

                        });

        </script>

    </body>
</html>
